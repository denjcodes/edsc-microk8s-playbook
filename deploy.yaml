---
# ----------------------------------------------------
# ----------------------------------------------------
# Create OpenStack resources cluster and wait for cloud init to finish
- name: Create OpenStack resources cluster
  hosts: localhost
  gather_facts: false
  roles:
    - role: openstack

- name: Wait for nodes to be ready
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait during nodes boot
      wait_for:
        host: "{{ansible_ssh_host}}"
        port: 22
        connect_timeout: 20
        timeout: 600
        search_regex: OpenSSH

    - name: Wait for ssh
      wait_for_connection:

# ----------------------------------------------------
# Scan SSH keys
# ----------------------------------------------------

- name: SSH keys
  hosts: localhost
  connection: local
  tags:
    - openstack
  roles:
    - role: ssh-keys

# ----------------------------------------------------
# Wait for nodes to be ready
# ----------------------------------------------------

- name: Wait for nodes to be ready
  hosts: all
  gather_facts: False
  tags:
    - openstack
  tasks:
    - name: Wait for cloud-init to finish
      raw: while ! test -f /var/lib/cloud/instance/boot-finished; do sleep 1; done
      retries: 5
      delay: 1
      changed_when: False
      tags:
        - skip_ansible_lint

#-------------------------------------------------------
# Configure password-based login for user ubuntu
#-------------------------------------------------------
- name: Configure password-based login for user ubuntu
  hosts: all
  gather_facts: True
  become: true
  become_user: root
  tags:
    - openstack
  tasks:
    - name: Allow password-based login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^PasswordAuthentication no$"
        line: "PasswordAuthentication yes"
        owner: root
        group: root
      when: enable_password_login_for_user_ubuntu == True

    - name: Change Password for user ubuntu
      user: name=ubuntu password="{{ password_for_user_ubuntu | password_hash('sha512', 'saltdfjalsdf') }}" update_password=always
      when: enable_password_login_for_user_ubuntu == True

    - name: Restart sshd
      service:
        name: ssh
        state: restarted
      when: enable_password_login_for_user_ubuntu == True

# ----------------------------------------------------
# Install microk8s
# ----------------------------------------------------

- name: Install microk8s
  hosts: all
  user: ubuntu
  become: yes
  become_user: root
  tags:
    - base
  roles:
    - role: microk8s

# ----------------------------------------------------
# Fix permissions of kubeconf file
# ----------------------------------------------------

- name: Fix permissions of kubeconf file
  hosts: localhost
  connection: local
  tasks:
    - name: Download kubeconf
      ansible.builtin.file:
        path: "{{generated_kubeconf_file}}"
        mode: "0600"
